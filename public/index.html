<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anotalk</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --chat-bg: #ffffff;
            --text-color: #333;
            --header-bg: #0084ff;
            --my-msg-bg: #0084ff;
            --stranger-msg-bg: #f0f0f0;
        }

        body.dark-mode {
            --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --chat-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #111;
            --my-msg-bg: #3b82f6;
            --stranger-msg-bg: #333;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gradient); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; transition: background 0.5s; }
        #app { width: 100%; max-width: 500px; height: 85vh; background: var(--chat-bg); color: var(--text-color); display: flex; flex-direction: column; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; position: relative; }
        #header { padding: 15px; background: var(--header-bg); color: white; display: flex; justify-content: space-between; align-items: center; }
        .partner-name { font-weight: bold; font-size: 1.1rem; }
        .header-controls { display: flex; gap: 10px; }
        .icon-btn { background: none; border: none; color: white; cursor: pointer; padding: 5px; border-radius: 50%; transition: 0.2s; }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .icon-btn.active { background: #00c853; box-shadow: 0 0 10px #00c853; }
        .icon-btn.hang-up { background: #ff4444; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; list-style: none; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        #messages li { padding: 10px 15px; border-radius: 18px; max-width: 75%; word-wrap: break-word; font-size: 0.95rem; }
        .system { align-self: center; color: #888; font-style: italic; font-size: 0.85em; text-align: center; }
        
        /* JAV√çTVA: t√∂r√∂lve a # jel a pink el≈ël */
        .debug-msg { align-self: center; color: #d63384; font-family: monospace; font-size: 0.75em; background: #fde8f0; border: 1px solid pink; }
        
        .me { background: var(--my-msg-bg); color: white; align-self: flex-end; border-bottom-right-radius: 4px !important; }
        .partner { background: var(--stranger-msg-bg); color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 4px !important; }
        
        /* √öJ ST√çLUSOK A SZ√ÅML√ÅL√ìHOZ */
        #controls { padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; align-items: center; position: relative; }
        .input-wrapper { flex: 1; position: relative; display: flex; align-items: center; }
        input[type="text"] { width: 100%; padding: 12px; padding-right: 60px; border-radius: 25px; border: 1px solid #ccc; outline: none; box-sizing: border-box; }
        #char-count { position: absolute; right: 15px; font-size: 0.75rem; color: #888; pointer-events: none; }
        #btn-send { padding: 10px 20px; border-radius: 25px; border: none; background: #0084ff; color: white; cursor: pointer; flex-shrink: 0; }

        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; backdrop-filter: blur(5px); }
        #nickname-input { padding: 10px; border-radius: 5px; border: none; margin-bottom: 15px; width: 70%; text-align: center; font-size: 1rem; }
        #start-btn { padding: 15px 40px; background: #00c853; color: white; border: none; border-radius: 30px; font-size: 1.2rem; cursor: pointer; }
        #call-modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--chat-bg); padding: 20px; border-radius: 15px; box-shadow: 0 5px 30px rgba(0,0,0,0.5); text-align: center; z-index: 20; display: none; width: 80%; border: 1px solid #ddd; }
        .call-actions { display: flex; justify-content: space-around; margin-top: 20px; }
        .btn-accept { background: #00c853; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; }
        .btn-reject { background: #ff4444; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <div id="header">
        <span id="partner-display" class="partner-name">Ismeretlen</span>
        <div class="header-controls">
            <button id="call-btn" class="icon-btn" onclick="toggleCall()" disabled title="H√≠v√°s">
                <span class="material-icons">call</span>
            </button>
            <button id="disconnect-btn" class="icon-btn hang-up" onclick="disconnectPartner()" style="display:none;" title="Kil√©p√©s">
                <span class="material-icons">close</span>
            </button>
            <button class="icon-btn" onclick="document.body.classList.toggle('dark-mode')">
                <span class="material-icons">dark_mode</span>
            </button>
        </div>
    </div>

    <ul id="messages">
        <li class="system">√Åll√≠tsd be a neved √©s keress egy partnert!</li>
    </ul>

    <div id="controls">
        <div class="input-wrapper">
            <input id="input" type="text" placeholder="√úzenet..." disabled autocomplete="off" maxlength="500" />
            <span id="char-count">0/500</span>
        </div>
        <button id="btn-send" onclick="sendMessage()" disabled>K√ºld√©s</button>
    </div>

    <div id="call-modal">
        <h3>Bej√∂v≈ë h√≠v√°s...</h3>
        <div class="call-actions">
            <button class="btn-reject" onclick="rejectIncomingCall()">Elutas√≠t√°s</button>
            <button class="btn-accept" onclick="acceptIncomingCall()">Elfogad√°s</button>
        </div>
    </div>

    <div id="overlay">
        <h2 style="color: white;">Kezd√©s</h2>
        <input id="nickname-input" type="text" placeholder="√çrd be a beceneved (pl. Kinga)" maxlength="15">
        <button id="start-btn" onclick="startSearch()">Keres√©s</button>
        <p id="status-text" style="color: #ddd; margin-top: 15px; display: none;">V√°rakoz√°s...</p>
    </div>
    
    <audio id="remote-audio" autoplay playsinline></audio>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    
    const elements = {
        msgs: document.getElementById('messages'),
        input: document.getElementById('input'),
        btnSend: document.getElementById('btn-send'),
        overlay: document.getElementById('overlay'),
        startBtn: document.getElementById('start-btn'),
        status: document.getElementById('status-text'),
        nickInput: document.getElementById('nickname-input'),
        partnerDisplay: document.getElementById('partner-display'),
        discBtn: document.getElementById('disconnect-btn'),
        callBtn: document.getElementById('call-btn'),
        remoteAudio: document.getElementById('remote-audio'),
        callModal: document.getElementById('call-modal'),
        charCount: document.getElementById('char-count') // <--- √öJ ELEM
    };

    let localStream;
    let peerConnection;
    let isCalling = false;
    let pendingOffer = null;
    let candidateQueue = [];

    const rtcConfig = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' },
            { urls: 'stun:stun4.l.google.com:19302' }
        ]
    };

    function startSearch() {
        const nick = elements.nickInput.value.trim() || "N√©vtelen";
        elements.startBtn.style.display = 'none';
        elements.nickInput.style.display = 'none';
        elements.status.style.display = 'block';
        elements.status.textContent = "Partner keres√©se...";
        socket.emit('find_partner', nick);
    }

    function sendMessage() {
        const text = elements.input.value.trim();
        if (text) {
            socket.emit('message', text);
            elements.input.value = '';
            elements.charCount.textContent = "0/500"; // <--- Null√°z√°s
        }
    }

    function addMessage(text, type) {
        const li = document.createElement('li');
        li.textContent = text;
        li.className = type;
        elements.msgs.appendChild(li);
        elements.msgs.scrollTop = elements.msgs.scrollHeight;
    }

    // --- DEBUG √úZENETEK ---
    function logDebug(msg) {
        console.log(msg);
        addMessage(`üîß ${msg}`, 'debug-msg');
    }

    function disconnectPartner() {
        socket.emit('next_partner');
        endCall(true); 
        resetUI();
    }

    function resetUI() {
        elements.input.disabled = true;
        elements.btnSend.disabled = true;
        elements.discBtn.style.display = 'none';
        elements.callBtn.disabled = true;
        elements.callBtn.classList.remove('active');
        elements.partnerDisplay.textContent = "Ismeretlen";
        elements.callModal.style.display = 'none';
        candidateQueue = []; 
        pendingOffer = null;
        elements.overlay.style.display = 'flex';
        elements.startBtn.style.display = 'block';
        elements.nickInput.style.display = 'block';
        elements.status.style.display = 'none';
        
        // Reset char count
        elements.input.value = '';
        elements.charCount.textContent = "0/500";
    }

    socket.on('chat_start', (data) => {
        elements.overlay.style.display = 'none';
        elements.msgs.innerHTML = '';
        elements.partnerDisplay.textContent = data.partnerName;
        addMessage(`Kapcsol√≥dva: ${data.partnerName}`, 'system');
        elements.input.disabled = false;
        elements.btnSend.disabled = false;
        elements.input.focus();
        elements.discBtn.style.display = 'block';
        elements.callBtn.disabled = false;
    });

    socket.on('message', (data) => addMessage(data.text, data.from));

    socket.on('partner_disconnected', () => {
        addMessage('A partner kil√©pett.', 'system');
        endCall(true);
        setTimeout(() => {
            resetUI();
            elements.status.textContent = "A partner bontotta.";
            elements.status.style.display = 'block';
        }, 2000);
    });

    // --- H√çV√ÅS LOGIKA ---

    async function toggleCall() {
        if (isCalling) {
            endCall(false); 
        } else {
            await startCall();
        }
    }

    async function startCall() {
        try {
            logDebug("Mikrofon k√©r√©se...");
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            logDebug("Mikrofon OK.");
            
            createPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            socket.emit('signal', { type: 'offer', sdp: offer });
            
            updateCallUI(true);
            addMessage("H√≠v√°s ind√≠t√°sa...", "system");
        } catch (err) {
            console.error(err);
            logDebug("Hiba: " + err.name + " - " + err.message);
            alert("Hiba: Nem siker√ºlt el√©rni a mikrofont!");
        }
    }

    async function acceptIncomingCall() {
        elements.callModal.style.display = 'none';
        if (!pendingOffer) return;

        try {
            logDebug("H√≠v√°s elfogad√°sa...");
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            createPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            updateCallUI(true);

            await peerConnection.setRemoteDescription(new RTCSessionDescription(pendingOffer));
            
            // Queue feldolgoz√°sa
            logDebug(`Feldolgoz√°s: ${candidateQueue.length} ICE jel√∂lt v√°r.`);
            while (candidateQueue.length > 0) {
                const candidate = candidateQueue.shift();
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('signal', { type: 'answer', sdp: answer });
            addMessage("H√≠v√°s elfogadva!", "system");
        } catch(e) { 
            console.error(e);
            logDebug("Hiba az elfogad√°sn√°l: " + e.message);
        }
        pendingOffer = null;
    }

    function rejectIncomingCall() {
        elements.callModal.style.display = 'none';
        pendingOffer = null;
        candidateQueue = [];
        socket.emit('signal', { type: 'reject' });
        addMessage("H√≠v√°s elutas√≠tva.", "system");
    }

    function endCall(isIncoming = false) {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        updateCallUI(false);
        elements.callModal.style.display = 'none';
        candidateQueue = [];

        if (!isIncoming) {
            socket.emit('signal', { type: 'hangup' });
            addMessage("A h√≠v√°s v√©get √©rt.", "system");
        }
    }

    function createPeerConnection() {
        logDebug("PeerConnection l√©trehoz√°sa...");
        peerConnection = new RTCPeerConnection(rtcConfig);
        
        // --- DIAGNOSZTIKA ---
        peerConnection.oniceconnectionstatechange = () => {
            logDebug(`√Ållapot: ${peerConnection.iceConnectionState}`);
        };

        peerConnection.onconnectionstatechange = () => {
             logDebug(`Kapcsolat: ${peerConnection.connectionState}`);
        };

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('signal', { type: 'candidate', candidate: event.candidate });
            }
        };
        
        peerConnection.ontrack = (event) => {
            logDebug("Hang s√°v meg√©rkezett a partnert≈ël!");
            elements.remoteAudio.srcObject = event.streams[0];
            elements.remoteAudio.play().catch(e => logDebug("Autoplay hiba: " + e.message));
        };
    }

    function updateCallUI(active) {
        isCalling = active;
        if (active) {
            elements.callBtn.classList.add('active');
            elements.callBtn.querySelector('span').textContent = 'mic';
        } else {
            elements.callBtn.classList.remove('active');
            elements.callBtn.querySelector('span').textContent = 'call';
        }
    }

    socket.on('signal', async (data) => {
        if (data.type === 'offer') {
            if (!isCalling) {
                pendingOffer = data.sdp;
                elements.callModal.style.display = 'block';
                logDebug("Bej√∂v≈ë h√≠v√°s aj√°nlat (Offer)!");
            }
        } 
        else if (data.type === 'answer') {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
            addMessage("A partner fogadta a h√≠v√°st!", "system");
            logDebug("V√°lasz (Answer) fogadva!");
        } 
        else if (data.type === 'candidate') {
            if (peerConnection && peerConnection.remoteDescription) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            } else {
                candidateQueue.push(data.candidate);
            }
        }
        else if (data.type === 'hangup') {
            endCall(true);
            addMessage("A h√≠v√°s v√©get √©rt.", "system");
        }
        else if (data.type === 'reject') {
            addMessage("A h√≠v√°st elutas√≠tott√°k.", "system");
            endCall(true);
        }
    });

    elements.input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // √öJ: Sz√°ml√°l√≥ friss√≠t√©se
    elements.input.addEventListener('input', () => {
        const currentLength = elements.input.value.length;
        elements.charCount.textContent = `${currentLength}/500`;
    });
</script>
</body>
</html>
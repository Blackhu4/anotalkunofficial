<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anotalk</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --chat-bg: #ffffff;
            --text-color: #333;
            --header-bg: #0084ff;
            --my-msg-bg: #0084ff;
            --stranger-msg-bg: #f0f0f0;
        }

        body.dark-mode {
            --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --chat-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #111;
            --my-msg-bg: #3b82f6;
            --stranger-msg-bg: #333;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-gradient); margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; transition: background 0.5s; }
        
        #app { width: 100%; max-width: 500px; height: 85vh; background: var(--chat-bg); color: var(--text-color); display: flex; flex-direction: column; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; position: relative; }
        
        #header { padding: 15px; background: var(--header-bg); color: white; display: flex; justify-content: space-between; align-items: center; }
        .partner-name { font-weight: bold; font-size: 1.1rem; }
        
        .header-controls { display: flex; gap: 10px; }
        .icon-btn { background: none; border: none; color: white; cursor: pointer; padding: 5px; border-radius: 50%; transition: 0.2s; }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .icon-btn.active { background: #00c853; box-shadow: 0 0 10px #00c853; }
        .icon-btn.hang-up { background: #ff4444; }

        #messages { flex: 1; overflow-y: auto; padding: 20px; list-style: none; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        #messages li { padding: 10px 15px; border-radius: 18px; max-width: 75%; word-wrap: break-word; font-size: 0.95rem; }
        .system { align-self: center; color: #888; font-style: italic; font-size: 0.85em; }
        .me { background: var(--my-msg-bg); color: white; align-self: flex-end; border-bottom-right-radius: 4px !important; }
        .partner { background: var(--stranger-msg-bg); color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 4px !important; }

        #controls { padding: 15px; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ccc; outline: none; }
        #btn-send { padding: 10px 20px; border-radius: 25px; border: none; background: #0084ff; color: white; cursor: pointer; }
        
        /* Overlay stílus (Keresés) */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; backdrop-filter: blur(5px); }
        #nickname-input { padding: 10px; border-radius: 5px; border: none; margin-bottom: 15px; width: 70%; text-align: center; font-size: 1rem; }
        #start-btn { padding: 15px 40px; background: #00c853; color: white; border: none; border-radius: 30px; font-size: 1.2rem; cursor: pointer; }
        
        /* Hívás Modal Stílus (ÚJ) */
        #call-modal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--chat-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
            text-align: center;
            z-index: 20;
            display: none; /* Alapból rejtett */
            width: 80%;
            border: 1px solid #ddd;
        }
        #call-modal h3 { margin-top: 0; }
        .call-actions { display: flex; justify-content: space-around; margin-top: 20px; }
        .btn-accept { background: #00c853; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; }
        .btn-reject { background: #ff4444; color: white; padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; }

    </style>
</head>
<body>

<div id="app">
    <div id="header">
        <span id="partner-display" class="partner-name">Ismeretlen</span>
        <div class="header-controls">
            <button id="call-btn" class="icon-btn" onclick="toggleCall()" disabled title="Hívás">
                <span class="material-icons">call</span>
            </button>
            <button id="disconnect-btn" class="icon-btn hang-up" onclick="disconnectPartner()" style="display:none;" title="Kilépés">
                <span class="material-icons">close</span>
            </button>
            <button class="icon-btn" onclick="document.body.classList.toggle('dark-mode')">
                <span class="material-icons">dark_mode</span>
            </button>
        </div>
    </div>

    <ul id="messages">
        <li class="system">Állítsd be a neved és keress egy partnert!</li>
    </ul>

    <div id="controls">
        <input id="input" type="text" placeholder="Üzenet..." disabled autocomplete="off" />
        <button id="btn-send" onclick="sendMessage()" disabled>Küldés</button>
    </div>

    <div id="call-modal">
        <h3>Bejövő hívás...</h3>
        <p>A partnered hanghívást kezdeményezett.</p>
        <div class="call-actions">
            <button class="btn-reject" onclick="rejectIncomingCall()">Elutasítás</button>
            <button class="btn-accept" onclick="acceptIncomingCall()">Elfogadás</button>
        </div>
    </div>

    <div id="overlay">
        <h2 style="color: white;">Kezdés</h2>
        <input id="nickname-input" type="text" placeholder="Írd be a beceneved (pl. Kinga)" maxlength="15">
        <button id="start-btn" onclick="startSearch()">Keresés</button>
        <p id="status-text" style="color: #ddd; margin-top: 15px; display: none;">Várakozás...</p>
    </div>
    
    <audio id="remote-audio" autoplay></audio>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    
    // UI elemek
    const elements = {
        msgs: document.getElementById('messages'),
        input: document.getElementById('input'),
        btnSend: document.getElementById('btn-send'),
        overlay: document.getElementById('overlay'),
        startBtn: document.getElementById('start-btn'),
        status: document.getElementById('status-text'),
        nickInput: document.getElementById('nickname-input'),
        partnerDisplay: document.getElementById('partner-display'),
        discBtn: document.getElementById('disconnect-btn'),
        callBtn: document.getElementById('call-btn'),
        remoteAudio: document.getElementById('remote-audio'),
        callModal: document.getElementById('call-modal') // Új modal
    };

    let localStream;
    let peerConnection;
    let isCalling = false;
    let pendingOffer = null; // Itt tároljuk a hívást, amíg el nem fogadod

    const rtcConfig = {
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    };

    // --- Csevegés logika ---

    function startSearch() {
        const nick = elements.nickInput.value.trim() || "Névtelen";
        elements.startBtn.style.display = 'none';
        elements.nickInput.style.display = 'none';
        elements.status.style.display = 'block';
        elements.status.textContent = "Partner keresése...";
        socket.emit('find_partner', nick);
    }

    function sendMessage() {
        const text = elements.input.value.trim();
        if (text) {
            socket.emit('message', text);
            elements.input.value = '';
        }
    }

    function addMessage(text, type) {
        const li = document.createElement('li');
        li.textContent = text;
        li.className = type;
        elements.msgs.appendChild(li);
        elements.msgs.scrollTop = elements.msgs.scrollHeight;
    }

    function disconnectPartner() {
        socket.emit('next_partner');
        endCall(true); 
        resetUI();
    }

    function resetUI() {
        elements.input.disabled = true;
        elements.btnSend.disabled = true;
        elements.discBtn.style.display = 'none';
        elements.callBtn.disabled = true;
        elements.callBtn.classList.remove('active');
        elements.partnerDisplay.textContent = "Ismeretlen";
        elements.callModal.style.display = 'none'; // Modal eltüntetése biztos ami biztos

        elements.overlay.style.display = 'flex';
        elements.startBtn.style.display = 'block';
        elements.nickInput.style.display = 'block';
        elements.status.style.display = 'none';
    }

    // --- Socket események ---

    socket.on('chat_start', (data) => {
        elements.overlay.style.display = 'none';
        elements.msgs.innerHTML = '';
        elements.partnerDisplay.textContent = data.partnerName;
        addMessage(`Kapcsolódva: ${data.partnerName}`, 'system');
        elements.input.disabled = false;
        elements.btnSend.disabled = false;
        elements.input.focus();
        elements.discBtn.style.display = 'block';
        elements.callBtn.disabled = false;
    });

    socket.on('message', (data) => addMessage(data.text, data.from));

    socket.on('partner_disconnected', () => {
        addMessage('A partner kilépett.', 'system');
        endCall(true);
        setTimeout(() => {
            resetUI();
            elements.status.textContent = "A partner bontotta.";
            elements.status.style.display = 'block';
        }, 2000);
    });

    // --- HÍVÁS LOGIKA (WebRTC + Popup) ---

    // Gombnyomásra indul (Hívó fél)
    async function toggleCall() {
        if (isCalling) {
            endCall(false); 
        } else {
            await startCall();
        }
    }

    // Hívás indítása (Hívó fél)
    async function startCall() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            createPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            socket.emit('signal', { type: 'offer', sdp: offer });
            
            updateCallUI(true);
            addMessage("Hívás indítása... (Várakozás válaszra)", "system");
        } catch (err) {
            console.error(err);
            alert("Mikrofon hiba!");
        }
    }

    // Elfogadás gomb (Hívott fél)
    async function acceptIncomingCall() {
        elements.callModal.style.display = 'none'; // Popup eltüntetése
        
        if (!pendingOffer) return;

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            createPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            updateCallUI(true);

            await peerConnection.setRemoteDescription(new RTCSessionDescription(pendingOffer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('signal', { type: 'answer', sdp: answer });
            addMessage("Hívás elfogadva!", "system");
        } catch(e) { console.error(e); }
        
        pendingOffer = null; // Töröljük a tárolót
    }

    // Elutasítás gomb (Hívott fél)
    function rejectIncomingCall() {
        elements.callModal.style.display = 'none';
        pendingOffer = null;
        socket.emit('signal', { type: 'reject' }); // Jelzünk a másiknak
        addMessage("Hívás elutasítva.", "system");
    }

    // Bontás
    function endCall(isIncoming = false) {
        if (peerConnection) {
            peerConnection.close();
            peerConnection = null;
        }
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        updateCallUI(false);
        elements.callModal.style.display = 'none'; // Ha esetleg nyitva maradt

        if (!isIncoming) {
            socket.emit('signal', { type: 'hangup' });
            addMessage("A hívás véget ért.", "system");
        }
    }

    function createPeerConnection() {
        peerConnection = new RTCPeerConnection(rtcConfig);
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) socket.emit('signal', { type: 'candidate', candidate: event.candidate });
        };
        peerConnection.ontrack = (event) => {
            elements.remoteAudio.srcObject = event.streams[0];
        };
    }

    function updateCallUI(active) {
        isCalling = active;
        if (active) {
            elements.callBtn.classList.add('active');
            elements.callBtn.querySelector('span').textContent = 'mic';
        } else {
            elements.callBtn.classList.remove('active');
            elements.callBtn.querySelector('span').textContent = 'call';
        }
    }

    // JELZÉSEK KEZELÉSE
    socket.on('signal', async (data) => {
        if (data.type === 'offer') {
            // BEJÖVŐ HÍVÁS -> NEM fogadjuk el azonnal, hanem popup!
            if (!isCalling) {
                pendingOffer = data.sdp; // Eltároljuk későbbre
                elements.callModal.style.display = 'block'; // Megjelenítjük az ablakot
            }
        } 
        else if (data.type === 'answer') {
            // A másik fél elfogadta
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
            addMessage("A partner fogadta a hívást!", "system");
        } 
        else if (data.type === 'reject') {
            // A másik fél ELUTASÍTOTTA
            addMessage("A hívást elutasították.", "system");
            endCall(true); // Bontjuk a mi oldalunkon is
        }
        else if (data.type === 'candidate') {
            if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
        else if (data.type === 'hangup') {
            endCall(true);
            addMessage("A hívás véget ért.", "system");
        }
    });

    elements.input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>
</body>
</html>